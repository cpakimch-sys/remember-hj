<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <title>- ì•ˆë…•! ê¹€íš¨ì •íšŒê³„ì‚¬ë‹˜ -</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #ffffff;
      color: #1f2937;
      padding: 40px;
    }
    .container {
    max-width: 1500px;   /* ğŸ”¹ í•µì‹¬ */
    margin: 0 auto;
    padding: 40px 20px;  /* ëª¨ë°”ì¼ ì•ˆì „ */
    transform: translateX(3cm);  
    }
    h1 {
      text-align: center;
      margin-bottom: 32px;
    }
    .card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;          /* ğŸ”¹ ë‘¥ê¸€ê²Œ */
      padding: 28px;                /* ğŸ”¹ ì—¬ìœ  */
      margin-bottom: 28px;
    }

    .section-title {
    font-size: 1.4rem;            /* í¼ */
    font-weight: 700;             /* ë³¼ë“œ */
    margin-bottom: 16px;
    padding-bottom: 10px;

    border-bottom: 2px solid #e5e7eb; /* ğŸ”¹ ë°‘ì„  */
   } 

    textarea {
      width: 100%;
      height: 120px;
      margin-top: 8px;
      padding: 10px;
      box-sizing: border-box;
    }
    button {
      margin-top: 12px;
      padding: 8px 16px;
      border: none;
      background: #111827;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background: #374151;
    }
    img {
      max-width: 100%;
      margin-top: 10px;
      border-radius: 6px;
    }
    .hidden {
      display: none;
    }

  /* ğŸ´ ì—½ì„œ ì‚¬ì§„ ì»¬ëŸ¼ */


.main-layout {
  display: grid;
  grid-template-columns: 1fr 3fr 2fr;  /* â­ ìœ ë™ ë¹„ìœ¨ */
  gap: 40px;
  align-items: flex-start;
}

.postcard-column {
  min-width: 220px;
}

.postcard-list {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.postcard {
  background: white;
  border-radius: 14px;
  overflow: hidden;
  border: 1px solid #e5e7eb;
  box-shadow: 0 8px 20px rgba(0,0,0,0.08);
}

.postcard img {
  width: 100%;
  aspect-ratio: 3 / 4;
  object-fit: cover;
  display: block;
}

.postcard-caption {
  padding: 10px 12px;
  font-size: 13px;
  color: #4b5563;
  text-align: center;
  background: #fafafa;
}

/* ğŸŒ¸ ë©”ì¸ íƒ€ì´í‹€ */
.title-main {
  font-size: 5rem;        /* 3.2rem â†’ ì •í™•íˆ 2ë°° */
  font-weight: 800;         /* 1000ì€ ê³¼í•¨ */
  text-align: center;
  margin-bottom: 20px;      /* ì—¬ë°±ë„ ì ˆë°˜ */
  letter-spacing: -0.04em;
  line-height: 1.0;

  font-family:
    "Arial Rounded MT Bold",
    "Segoe UI Rounded",
    "Apple SD Gothic Neo",
    "NanumSquareRound",
    system-ui,
    sans-serif;
}

.page-header {
  padding: 5px 20px 25px;
  text-align: center;
}

@media (max-width: 600px) {.title-main {font-size: 3.6rem;}.page-header {padding: 10px 20px 12px;}}

.sticky-note {
  position: absolute;
  width: 200px;
  min-height: 100px;
  padding: 10px;
  background: #fff8b3;
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
  cursor: move;
  font-size: 14px;
}


  </style>
</head>


<button
  id="addStickyBtn"
  disabled
  style="
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 200;
    padding: 12px 18px;
    border-radius: 999px;
    background: #9ca3af;   /* ë¹„í™œì„± íšŒìƒ‰ */
    color: white;
    font-size: 14px;
    cursor: not-allowed;
  "
>
  â• í¬ìŠ¤íŠ¸ì‡ ë¶™ì´ê¸°
</button>

<body>

<header class="page-header">
  <h1 class="title-main">- ì•ˆë…•! ê¹€íš¨ì • íšŒê³„ì‚¬ë‹˜ - </h1>
</header>

<div class="container">

  <div class="main-layout">

    <!-- ğŸ´ ì™¼ìª½ ì—½ì„œ ì‚¬ì§„ -->
    <div class="postcard-column">
      <div class="postcard-list">
        <div class="postcard">
          <img src="photo1.png" alt="ê¹€íš¨ì • íšŒê³„ì‚¬ë‹˜ê³¼ ì•„ì´">
          <div class="postcard-caption">
            í•¨ê»˜ ì›ƒë˜ ë‚ 
          </div>
        </div>

        <div class="postcard">
          <img src="photo2.png" alt="ê¹€íš¨ì • íšŒê³„ì‚¬ë‹˜">
          <div class="postcard-caption">
            ê°€ì¥ ë”°ëœ»í–ˆë˜ ìˆœê°„
          </div>
        </div>

      </div>
    </div>

    <!-- ğŸ‘‰ ì˜¤ë¥¸ìª½: ê¸°ì¡´ ë‚´ìš© (ê·¸ëŒ€ë¡œ) -->
    <div class="content-area">
      <!-- ë¡œê·¸ì¸ ì¹´ë“œ -->
      <div id="loginCard" class="card">
        <button onclick="loginWithGoogle()">ğŸ” êµ¬ê¸€ë¡œ ë¡œê·¸ì¸</button>
      </div>

      <!-- ê¸€ ì‘ì„± -->
      <div id="writeCard" class="card hidden">
        <h2 class="section-title">ê¸°ì–µ ë‚¨ê¸°ê¸°</h2>
        <textarea id="message" placeholder="ë‹¹ì‹ ì˜ ê¸°ì–µì„ ë‚¨ê²¨ì£¼ì„¸ìš”"></textarea>
        <input type="file" id="image" accept="image/*" />
        <button id="submitBtn">ê¸°ì–µ ë‚¨ê¸°ê¸°</button>
      </div>

      <!-- ëª©ë¡ -->
      <div id="listCard" class="card hidden">
        <h2 class="section-title">ë‚¨ê²¨ì§„ ê¸°ì–µë“¤</h2>
        <div id="list"></div>
      </div>

    </div> <!-- content-area -->

  <!-- ğŸŸ¨ ì˜¤ë¥¸ìª½: í•¨ê»˜í•œ ë°œìì·¨ -->
  <aside class="right-column">
    <div class="footprint-card">
      <h3 class="footprint-title">í•¨ê»˜í•œ ë°œìì·¨</h3>

      <ul class="timeline">
        <li><span class="text">2020.11 HANA 2020-4 Program</span></li>
        <li><span class="text">2020.11 KNB 2020-3 Program</span></li>
        <li><span class="text">2021.02 HANA 2021-1 Program</span></li>     
        <li><span class="text">2021.06 SHB 2021-2 Program</span></li>
        <li><span class="text">2021.05 NH 2021-2 Program</span></li>
        <li><span class="text">2021.05 SHB 2021-2 Program</span></li>
        <li><span class="text">2021.09 WRB 2021-3 Program</span></li>
        <li><span class="text">2021.09 NH 2021-3 Program</span></li>
        <li><span class="text">2021.11 NH 2021-4 Program</span></li>
        <li><span class="text">2022.02 BNK 2022-1 Program</span></li>
        <li><span class="text">2022.02 NH 2022-1 Program</span></li>



      </ul>

    </div>
  </aside>  

  </div> <!-- main-layout -->

<!-- ğŸ§· í¬ìŠ¤íŠ¸ì‡ ì»¨í…Œì´ë„ˆ ì¶”ê°€ -->
<div id="stickyContainer" style="position: relative; width: 100%; height: 600px;"></div>


</div> <!-- container -->


<!-- ğŸ’¬ íšŒì‹  íŒì—… -->
<div id="replyModal" class="hidden"
     style="
       position: fixed;
       inset: 0;
       background: rgba(0,0,0,0.4);
       align-items: center;
       justify-content: center;
       z-index: 999;
     ">
  <div style="
       background: white;
       width: 360px;
       padding: 24px;
       border-radius: 12px;
       text-align: center;
       box-shadow: 0 10px 25px rgba(0,0,0,0.2);
     ">
    <h3 style="margin-bottom: 12px;">ê¹€íš¨ì • íšŒê³„ì‚¬ë‹˜</h3>
    <p id="replyText" style="margin-bottom: 20px; line-height: 1.6;">
      ê¸€ ì˜ ì½ì—ˆì–´ìš”. ê³ ë§ˆì›Œìš”.
    </p>
    <button onclick="closeReply()">ë‹«ê¸°</button>
  </div>
</div>


<script>
  /* âœ… Supabase í´ë¼ì´ì–¸íŠ¸ (í•˜ë‚˜ë§Œ!) */
  const supabaseClient = window.supabase.createClient(
  "https://upxuhfajteosglolyctq.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVweHVoZmFqdGVvc2dsb2x5Y3RxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5MjY5MzAsImV4cCI6MjA4MjUwMjkzMH0.ZlN9--ksRnn92I0vRqEB2Ph88vixMHo5uKyBG1qDbGM",
    {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
      flowType: "pkce"
    }
    }
  );

  /* âœ… êµ¬ê¸€ ë¡œê·¸ì¸ */
  async function loginWithGoogle() {
  await supabaseClient.auth.signInWithOAuth({
    provider: "google",
    options: {
      redirectTo: window.location.origin
      }
    });
  }

  /* âœ… ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬ */
  supabaseClient.auth.onAuthStateChange((_event, session) => {
  if (!session) return;

  document.getElementById("loginCard").classList.add("hidden");
  document.getElementById("writeCard").classList.remove("hidden");
  document.getElementById("listCard").classList.remove("hidden");

  const btn = document.getElementById("addStickyBtn");
  btn.disabled = false;
  btn.style.background = "#111827";
  btn.style.cursor = "pointer";

  loadMemories();
  loadStickies();
  });

  /* âœ… ê¸€ ì €ì¥ */
  async function submitMemory() {
    const message = document.getElementById("message").value;
    const fileInput = document.getElementById("image");
    let imageUrl = null;

    if (!message.trim()) return;

    if (fileInput.files.length > 0) {
      const file = fileInput.files[0];
      const fileName = `${Date.now()}_${file.name}`;

      const { error } = await supabaseClient
        .storage
        .from("uploads")
        .upload(fileName, file);

      if (!error) {
        imageUrl = supabaseClient
          .storage
          .from("uploads")
          .getPublicUrl(fileName).data.publicUrl;
      }
    }

    const {
  data: { session }
  } = await supabaseClient.auth.getSession();

  const author =
    session?.user?.user_metadata?.full_name ||
    session?.user?.email ||
    "ìµëª…";

  await supabaseClient.from("memories").insert([
    {
      message,
      image_url: imageUrl,
      author
    }
  ]);

    document.getElementById("message").value = "";
    fileInput.value = "";
    loadMemories();
    loadStickies();
    showReply();
  }

  document
    .getElementById("submitBtn")
    .addEventListener("click", submitMemory);



// 3. ì´ˆê¸° ë¡œë“œ ì‹œ ê¸°ì¡´ í¬ìŠ¤íŠ¸ì‡ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadStickies() {
  const { data, error } = await supabaseClient
    .from("stickies")
    .select("*")
    .order("created_at", { ascending: true });

  if (error) {
    console.error(error);
    return;
  }
  
  const container = document.getElementById("stickyContainer");
  container.innerHTML = "";

  for (const sticky of data) {
  const note = await createStickyElement(sticky);
  if (!note) continue;

  note.title = sticky.user_id;
  container.appendChild(note);
}
}


// 1. í¬ìŠ¤íŠ¸ì‡ DOM ìƒì„±
async function createStickyElement(sticky) {
  if (!sticky) {
    console.error("âŒ createStickyElement: sticky is null", sticky);
    return null;
  }

  const { x, y, content, color, id, user_id } = sticky;

  if (x == null || y == null) {
    console.error("âŒ sticky position missing", sticky);
    return null;
  }

  const note = document.createElement("div");
  note.className = "sticky-note";
  note.style.left = `${x}px`;
  note.style.top = `${y}px`;
  note.style.background = color || "#fff8b3";
  note.innerText = content || "ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”";
  note.dataset.id = id;

  const { data } = await supabaseClient.auth.getSession();
  const isOwner = data.session?.user.id === user_id;

  if (isOwner) {
    note.contentEditable = true;
    makeDraggable(note);

    note.addEventListener("blur", async () => {
      await supabaseClient
        .from("stickies")
        .update({ content: note.innerText })
        .eq("id", id);
    });
  } else {
    note.contentEditable = false;
    note.style.cursor = "default";
    note.style.opacity = 0.85;
  }
  return note;
}


function makeDraggable(el) {
  let isDown = false;
  let offsetX = 0;
  let offsetY = 0;

  el.addEventListener("mousedown", (e) => {
    isDown = true;
    offsetX = e.offsetX;
    offsetY = e.offsetY;
    el.style.zIndex = 1000;
  });

  document.addEventListener("mousemove", (e) => {
    if (!isDown) return;
    const container = document.getElementById("stickyContainer");
    const rect = container.getBoundingClientRect();

    el.style.left = `${e.clientX - rect.left - offsetX}px`;
    el.style.top = `${e.clientY - rect.top - offsetY}px`;
  });

  document.addEventListener("mouseup", async () => {
  if (!isDown) return;

  isDown = false;

  await supabaseClient
    .from("stickies")
    .update({
      x: parseInt(el.style.left),
      y: parseInt(el.style.top)
    })
    .eq("id", el.dataset.id);
  });
}

  /* ==========================
  ğŸ§· í¬ìŠ¤íŠ¸ì‡ ì €ì¥ í•¨ìˆ˜
  ========================== */ 

async function saveSticky({ x, y, content, color }) {
  const {
    data: { session }
  } = await supabaseClient.auth.getSession();

  if (!session) {
    alert("ë¡œê·¸ì¸ í›„ í¬ìŠ¤íŠ¸ì‡ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
    return null;
  }

  const payload = {
    x,
    y,
    content,
    color,
    user_id: session.user.id
  };

  console.log("ğŸ“Œ sticky payload", payload); // âœ… ì •í™•í•œ ìœ„ì¹˜

  const { data, error } = await supabaseClient
    .from("stickies")
    .insert([payload])
    .select()
    .single();

    console.log("ğŸ“¦ saved sticky", data, error);

  if (error) {
    console.error("í¬ìŠ¤íŠ¸ì‡ ì €ì¥ ì‹¤íŒ¨:", error);
    return null;
  }
  return data;
}


  
  /* ==========================
     ğŸ’¬ ê¹€íš¨ì • íšŒê³„ì‚¬ë‹˜ íšŒì‹  íŒì—…
     ========================== */

  const replyMessages = [
    "ê¸€ ì˜ ì½ì—ˆì–´ìš”. ê³ ë§ˆì›Œìš”.",
    "ë‹¹ì‹ ì˜ ë§ˆìŒì´ ì „í•´ì¡Œì–´ìš”. ì •ë§ ê³ ë§ˆì›Œìš”.",
    "ì´ë ‡ê²Œ ê¸°ì–µí•´ì¤˜ì„œ ê°ì‚¬í•´ìš”.",
    "ë”°ëœ»í•œ ë§ˆìŒ, ì˜ ë°›ì•˜ì–´ìš”.",
    "ì½ìœ¼ë©´ì„œ ì›ƒê³  ìš¸ì—ˆì–´ìš”. ê³ ë§ˆì›Œìš”."
  ];

  function showReply() {
    const modal = document.getElementById("replyModal");
    const text = document.getElementById("replyText");

    const msg =
      replyMessages[Math.floor(Math.random() * replyMessages.length)];

    text.innerText = msg;
    modal.classList.remove("hidden");
    modal.style.display = "flex";
  }

  function closeReply() {
    const modal = document.getElementById("replyModal");
    modal.classList.add("hidden");
    modal.style.display = "none";
  }



  /* âœ… ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° */
  async function loadMemories() {
    const { data } = await supabaseClient
      .from("memories")
      .select("*")
      .order("created_at", { ascending: false });

    const list = document.getElementById("list");
    list.innerHTML = "";

    data.forEach(item => {
      const div = document.createElement("div");
      div.className = "card";

      const date = new Date(item.created_at).toLocaleString("ko-KR");

      div.innerHTML = `
      <p style="white-space: pre-wrap;">${item.message}</p>

      ${item.image_url ? `<img src="${item.image_url}" />` : ""}

      <div style="margin-top:8px; font-size:13px; color:#6b7280;">
        <strong>${item.author || "ìµëª…"}</strong>
        Â· ì‘ì„±ì¼: ${date}
  </div>
  `;
   list.appendChild(div);
    });
  }

      // /* âœ… ìƒˆë¡œê³ ì¹¨ í›„ ë¡œê·¸ì¸ ìœ ì§€ */
      // supabaseClient.auth.getSession().then(({ data }) => {
      //   if (data.session) {
      //     document.getElementById("loginCard").classList.add("hidden");
      //     document.getElementById("writeCard").classList.remove("hidden");
      //     document.getElementById("listCard").classList.remove("hidden");
      //     loadMemories();
      //     loadStickies();
      //   }
      // });

// (async () => {
//   const { data, error } = await supabaseClient.auth.getSession();
//   console.log("ì„¸ì…˜ ì²´í¬:", data, error);
//   if (data?.session) {
//     document.getElementById("loginCard").classList.add("hidden");
//     document.getElementById("writeCard").classList.remove("hidden");
//     document.getElementById("listCard").classList.remove("hidden");
//     // âœ… ì—¬ê¸° ì¶”ê°€
//     const btn = document.getElementById("addStickyBtn");
//     btn.disabled = false;
//     btn.style.background = "#111827";
//     btn.style.cursor = "pointer";
//     loadMemories();
//     loadStickies();         
//   }


// // 2. ë²„íŠ¼ í´ë¦­ â†’ í¬ìŠ¤íŠ¸ì‡ ìƒì„±
// document
//   .getElementById("addStickyBtn")
//   .addEventListener("click", async () => {
//     const container = document.getElementById("stickyContainer");
//     const stickyData = await saveSticky({
//       x: 120,
//       y: 120,
//       content: "",
//       color: "#fff8b3"
//     });
//     const note = await createStickyElement(stickyData);
//     if (!note) return;
//     container.appendChild(note);
//     note.focus();
//   });

// })();
document.getElementById("addStickyBtn").addEventListener("click", async () => {
  const container = document.getElementById("stickyContainer");

  const stickyData = await saveSticky({
    x: 120,
    y: 120,
    content: "",
    color: "#fff8b3"
  });
  console.log("ğŸŸ¢ stickyData from save", stickyData);
  
  if (!stickyData) return;

  const note = await createStickyElement(stickyData);
  if (!note) return;

  container.appendChild(note);
  note.focus();
});

</script>

</body>

</html>

<!-- ì˜ ì•ˆë˜ê³  ìˆëŠ” ë²„ì „, í¬ìŠ¤íŠ¸ì‡ì€ ì–´ë µë„¤ -->