<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì•ˆë…•! ê¹€íš¨ì •íšŒê³„ì‚¬ë‹˜</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #ffffff;
      color: #1f2937;
      padding: 40px;
    }
    .container {
    max-width: 1100px;   /* ğŸ”¹ í•µì‹¬ */
    margin: 0 auto;
    padding: 40px 20px;  /* ëª¨ë°”ì¼ ì•ˆì „ */
    }
    h1 {
      text-align: center;
      margin-bottom: 32px;
    }
    .card {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
    }
    textarea {
      width: 100%;
      height: 120px;
      margin-top: 8px;
      padding: 10px;
      box-sizing: border-box;
    }
    button {
      margin-top: 12px;
      padding: 8px 16px;
      border: none;
      background: #111827;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background: #374151;
    }
    img {
      max-width: 100%;
      margin-top: 10px;
      border-radius: 6px;
    }
    .hidden {
      display: none;
    }

  /* ğŸ´ ì—½ì„œ ì‚¬ì§„ ì»¬ëŸ¼ */
.main-layout {
  display: flex;
  gap: 40px;
  align-items: flex-start;
}

.postcard-column {
  width: 220px;
  flex-shrink: 0;
}

.postcard-list {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.postcard {
  background: white;
  border-radius: 14px;
  overflow: hidden;
  border: 1px solid #e5e7eb;
  box-shadow: 0 8px 20px rgba(0,0,0,0.08);
}

.postcard img {
  width: 100%;
  aspect-ratio: 3 / 4;
  object-fit: cover;
  display: block;
}

.postcard-caption {
  padding: 10px 12px;
  font-size: 13px;
  color: #4b5563;
  text-align: center;
  background: #fafafa;
}



  </style>
</head>
<body>

<div class="container">
  <div class="main-layout">

    <!-- ğŸ´ ì™¼ìª½ ì—½ì„œ ì‚¬ì§„ -->
    <div class="postcard-column">
      <div class="postcard-list">

        <div class="postcard">
          <img src="photo1.png" alt="ê¹€íš¨ì • íšŒê³„ì‚¬ë‹˜ê³¼ ì•„ì´">
          <div class="postcard-caption">
            í•¨ê»˜ ì›ƒë˜ ë‚ 
          </div>
        </div>

        <div class="postcard">
          <img src="photo2.png" alt="ê¹€íš¨ì • íšŒê³„ì‚¬ë‹˜">
          <div class="postcard-caption">
            ê°€ì¥ ë”°ëœ»í–ˆë˜ ìˆœê°„
          </div>
        </div>

      </div>
    </div>

    <!-- ğŸ‘‰ ì˜¤ë¥¸ìª½: ê¸°ì¡´ ë‚´ìš© (ê·¸ëŒ€ë¡œ) -->
    <div class="content-area">

      <h1>ì•ˆë…•! ê¹€íš¨ì • íšŒê³„ì‚¬ë‹˜</h1>

      <!-- ë¡œê·¸ì¸ ì¹´ë“œ -->
      <div id="loginCard" class="card">
        <button onclick="loginWithGoogle()">ğŸ” êµ¬ê¸€ë¡œ ë¡œê·¸ì¸</button>
      </div>

      <!-- ê¸€ ì‘ì„± -->
      <div id="writeCard" class="card hidden">
        <h2>ê¸°ì–µ ë‚¨ê¸°ê¸°</h2>
        <textarea id="message" placeholder="ë‹¹ì‹ ì˜ ê¸°ì–µì„ ë‚¨ê²¨ì£¼ì„¸ìš”"></textarea>
        <input type="file" id="image" accept="image/*" />
        <button id="submitBtn">ê¸°ì–µ ë‚¨ê¸°ê¸°</button>
      </div>

      <!-- ëª©ë¡ -->
      <div id="listCard" class="card hidden">
        <h2>ë‚¨ê²¨ì§„ ê¸°ì–µë“¤</h2>
        <div id="list"></div>
      </div>

    </div> <!-- content-area -->

  </div> <!-- main-layout -->
</div> <!-- container -->




<!-- ğŸ’¬ íšŒì‹  íŒì—… -->
<div id="replyModal" class="hidden"
     style="
       position: fixed;
       inset: 0;
       background: rgba(0,0,0,0.4);
       align-items: center;
       justify-content: center;
       z-index: 999;
     ">
  <div style="
       background: white;
       width: 360px;
       padding: 24px;
       border-radius: 12px;
       text-align: center;
       box-shadow: 0 10px 25px rgba(0,0,0,0.2);
     ">
    <h3 style="margin-bottom: 12px;">ê¹€íš¨ì • íšŒê³„ì‚¬ë‹˜</h3>
    <p id="replyText" style="margin-bottom: 20px; line-height: 1.6;">
      ê¸€ ì˜ ì½ì—ˆì–´ìš”. ê³ ë§ˆì›Œìš”.
    </p>
    <button onclick="closeReply()">ë‹«ê¸°</button>
  </div>
</div>


<script>
  /* âœ… Supabase í´ë¼ì´ì–¸íŠ¸ (í•˜ë‚˜ë§Œ!) */
  const supabaseClient = window.supabase.createClient(
  "https://upxuhfajteosglolyctq.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVweHVoZmFqdGVvc2dsb2x5Y3RxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5MjY5MzAsImV4cCI6MjA4MjUwMjkzMH0.ZlN9--ksRnn92I0vRqEB2Ph88vixMHo5uKyBG1qDbGM",
    {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
      flowType: "pkce"
    }
    }
  );

  /* âœ… êµ¬ê¸€ ë¡œê·¸ì¸ */
  async function loginWithGoogle() {
  await supabaseClient.auth.signInWithOAuth({
    provider: "google",
    options: {
      redirectTo: window.location.origin
      }
    });
  }

  /* âœ… ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬ */
  supabaseClient.auth.onAuthStateChange((_event, session) => {
    if (session) {
      document.getElementById("loginCard").classList.add("hidden");
      document.getElementById("writeCard").classList.remove("hidden");
      document.getElementById("listCard").classList.remove("hidden");
      loadMemories();
    }
  });

  /* âœ… ê¸€ ì €ì¥ */
  async function submitMemory() {
    const message = document.getElementById("message").value;
    const fileInput = document.getElementById("image");
    let imageUrl = null;

    if (!message.trim()) return;

    if (fileInput.files.length > 0) {
      const file = fileInput.files[0];
      const fileName = `${Date.now()}_${file.name}`;

      const { error } = await supabaseClient
        .storage
        .from("uploads")
        .upload(fileName, file);

      if (!error) {
        imageUrl = supabaseClient
          .storage
          .from("uploads")
          .getPublicUrl(fileName).data.publicUrl;
      }
    }

    await supabaseClient.from("memories").insert([
      { message, image_url: imageUrl,author }
    ]);

    document.getElementById("message").value = "";
    fileInput.value = "";
    loadMemories();
    showReply();
  }

  document
    .getElementById("submitBtn")
    .addEventListener("click", submitMemory);

  
  /* ==========================
     ğŸ’¬ ê¹€íš¨ì • íšŒê³„ì‚¬ë‹˜ íšŒì‹  íŒì—…
     ========================== */

  const replyMessages = [
    "ê¸€ ì˜ ì½ì—ˆì–´ìš”. ê³ ë§ˆì›Œìš”.",
    "ë‹¹ì‹ ì˜ ë§ˆìŒì´ ì „í•´ì¡Œì–´ìš”. ì •ë§ ê³ ë§ˆì›Œìš”.",
    "ì´ë ‡ê²Œ ê¸°ì–µí•´ì¤˜ì„œ ê°ì‚¬í•´ìš”.",
    "ë”°ëœ»í•œ ë§ˆìŒ, ì˜ ë°›ì•˜ì–´ìš”.",
    "ì½ìœ¼ë©´ì„œ ì›ƒê³  ìš¸ì—ˆì–´ìš”. ê³ ë§ˆì›Œìš”."
  ];

  function showReply() {
    const modal = document.getElementById("replyModal");
    const text = document.getElementById("replyText");

    const msg =
      replyMessages[Math.floor(Math.random() * replyMessages.length)];

    text.innerText = msg;
    modal.classList.remove("hidden");
    modal.style.display = "flex";
  }

  function closeReply() {
    const modal = document.getElementById("replyModal");
    modal.classList.add("hidden");
    modal.style.display = "none";
  }



  /* âœ… ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° */
  async function loadMemories() {
    const { data } = await supabaseClient
      .from("memories")
      .select("*")
      .order("created_at", { ascending: false });

    const list = document.getElementById("list");
    list.innerHTML = "";

    data.forEach(item => {
      const div = document.createElement("div");
      div.className = "card";

      const date = new Date(item.created_at).toLocaleString("ko-KR");

      div.innerHTML = `
        <p>${item.message}</p>
        ${item.image_url ? `<img src="${item.image_url}" />` : ""}
        <small style="color:#6b7280;">ì‘ì„±ì¼: ${date}</small>
      `;
      list.appendChild(div);
    });
  }

  /* âœ… ìƒˆë¡œê³ ì¹¨ í›„ ë¡œê·¸ì¸ ìœ ì§€ */
  supabaseClient.auth.getSession().then(({ data }) => {
    if (data.session) {
      document.getElementById("loginCard").classList.add("hidden");
      document.getElementById("writeCard").classList.remove("hidden");
      document.getElementById("listCard").classList.remove("hidden");
      loadMemories();
    }
  });

(async () => {
  const { data, error } = await supabaseClient.auth.getSession();
  console.log("ì„¸ì…˜ ì²´í¬:", data, error);

  if (data?.session) {
    document.getElementById("loginCard").classList.add("hidden");
    document.getElementById("writeCard").classList.remove("hidden");
    document.getElementById("listCard").classList.remove("hidden");
    loadMemories();
  }
})();


</script>

</body>
</html>
